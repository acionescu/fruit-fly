<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Ephemeral microblogging app - proof of concept</title>

<script src="js/event-bus.js"></script>
<script src="js/status-app.js"></script>
<script src="../tp/jquery-2.1.1.js"></script>

<script src="../tp/jquery-ui.js"></script>

<link rel="stylesheet" href="../tp/jquery-ui.css">


<style type="text/css">
#connect-container {
	float: left;
	width: 400px
}

#connect-container div {
	padding: 5px;
}

#console-container {
	float: left;
	margin-left: 15px;
	width: 600px;
}

#console {
	border: 1px solid #CCCCCC;
	border-right-color: #999999;
	border-bottom-color: #999999;
	height: 500px;
	overflow-y: scroll;
	padding: 5px;
	width: 100%;
}

#console p {
	padding: 0;
	margin: 0;
}

#main-container {
	height: auto;
}

#data-container {
	float: left;
	height: 500px;
	width: 800px;
	padding: 10px;
}

.data-div {
	display: inline-block;
}

#our-data {
	padding-top: 20px;
	padding-bottom: 10px;
	margin-bottom: 50px;
	margin-top: 20px;
	border-top: thin solid;
}

#peer-id-cont {
	display: inline-block;
}

#peer-actions-cont {
	display: inline-block;
	float: right;
}

#peer-status-cont {
	padding-top: 10px;
}

#peers-data {
	margin-top: 20px;
	padding-bottom: 10px;
	border-top: thin solid;
}

.peer-data div {
	/*  	display: inline-block;  */
	
}

.peer-data {
	padding-bottom: 20px;
	padding-top: 15px;
	border-bottom: thin solid;
}

.peer-left {
	background-color: #ffaaaa;
}

.peer-active {
	background-color: #dddddd;
}
</style>
<script type="application/javascript">
    
    
        var wse = null;

        function setConnected(connected) {
            document.getElementById('connect').disabled = connected;
            document.getElementById('disconnect').disabled = !connected;
            document.getElementById('echo').disabled = !connected;
            document.getElementById('refresh-peers').disabled = !connected;
        }

        function connect() {
            var target = document.getElementById('target').value;
            if (target == '') {
                alert('Please select server side connection implementation.');
                return;
            }
	var wshandler = { 
	            onopen : function () {
	                setConnected(true);
	                $("#infoCont").hide();
	                log('Info: WebSocket connection opened.');
	            },
	            onmessage : function (event) {
// 	                log('Received: ' + event.data);
	            },
	            onclose : function (event) {
	                setConnected(false);
	                var msg = 'WebSocket connection closed, Code: ' + event.code + (event.reason == "" ? "" : ", Reason: " + event.reason);
	                
	                $("#infoCont").text(msg).show();
	                log(msg);
	            } 
	};

	 wse = new StatusAppClient(target,true,wshandler,appState);
        }

        function disconnect() {
            wse.close();
            setConnected(false);
        }

        function echo() {
            if (wse != null) {
                var message = document.getElementById('message').value;
                log('Sent: ' + message);
                wse.setStatus(message);
                setOurStatus(message);
            } else {
                alert('WebSocket connection not established, please connect.');
            }
        }
        
        function refreshPeers(){
            if(wse != null){
        	wse.requestPeersRefresh();
            }
        }

        function updateTarget(target) {
            if (window.location.protocol == 'http:') {
                document.getElementById('target').value = 'ws://' + window.location.host + target;
            } else {
                document.getElementById('target').value = 'wss://' + window.location.host + target;
            }
        }

        function log(message) {
//             var console = document.getElementById('console');
//             var p = document.createElement('p');
//             p.style.wordWrap = 'break-word';
//             p.appendChild(document.createTextNode(message));
//             console.appendChild(p);
//             while (console.childNodes.length > 25) {
//                 console.removeChild(console.firstChild);
//             }
//             console.scrollTop = console.scrollHeight;
	console.log(message);
        }


        document.addEventListener("DOMContentLoaded", function() {
            // Remove elements with "noscript" class - <noscript> is not allowed in XHTML
            var noscripts = document.getElementsByClassName("noscript");
            for (var i = 0; i < noscripts.length; i++) {
                noscripts[i].parentNode.removeChild(noscripts[i]);
            }
        }, false);

        
        function getOurDataContainer(){
            return document.getElementById('our-data');
        }
        
        function setOurId(id){
            var ourDataCont = document.getElementById('our-id');
            $(ourDataCont).text(id);
        }
        
        function setOurStatus(status){
            var ourDataCont = document.getElementById('our-status');
            $(ourDataCont).text(status);
        }
        
        
        function onPeerReplace(e,pcont){

            $(pcont).find("#replace-button").hide();
            $(pcont).find("#update-button").show();
           
            
            var idCont = $(pcont).find("#peer-id-cont");
            idCont.empty();
            idCont.append($("<input id='new-peer-id' type='text' size=37>").val(pcont.id));
        }
        
        function requestPeerReplace(e, pcont){
            wse.requestPeerReplace(pcont.id,$(pcont).find("#new-peer-id").val());
        }
        
        
        function replacePeer(oldPeerId,newPeerId){
            var dataCont = document.getElementById(oldPeerId);
            $(dataCont).find("#new-peer-id").remove();
            $(dataCont).find("#peer-id-cont").text(newPeerId).addClass("peer-active");
            $(dataCont).find("#peer-status-cont").text("-- waiting for a new status update");
            
            $(dataCont).find("#replace-button").show();
            $(dataCont).find("#update-button").hide();
            
            /* don't forget to change the id of the data container to the new peer */
            $(dataCont).attr("id",newPeerId);
        }
        
        function rollbackPeerReplace(peerId){
            var dataCont = document.getElementById(peerId);
            $(dataCont).find("#new-peer-id").remove();
            $(dataCont).find("#peer-id-cont").text(peerId).addClass("peer-active");
            
            $(dataCont).find("#replace-button").show();
            $(dataCont).find("#update-button").hide();
        }
        
        function getDelegateFunction(f,pcont){
            return function(e){
        	f.call(this,e,pcont);
            }
        }
        
        function setPeerData(peersData){
            var ourDataCont = document.getElementById('peers-data');
            clearElement(ourDataCont);
            for(var peerId  in peersData){
        	var pd = peersData[peerId];
        	var pcont = createPeerCont(peerId);
        	
        	$(pcont).find("#peer-id-cont").text(peerId).addClass("peer-active");
        	$(pcont).find("#peer-status-cont").text(pd.status);
        	
        	$(pcont).find("#replace-button").click(getDelegateFunction(onPeerReplace,pcont));
        	
        	$(pcont).find("#update-button").click(getDelegateFunction(requestPeerReplace,pcont));
        	
        	$(pcont).appendTo(ourDataCont);
        	
            };
        }
        
        function setPeerLeft(peerId){
            var dataCont = document.getElementById(peerId);
            if(dataCont){
        	var idCont = $(dataCont).find("#peer-id-cont");
        	idCont.removeClass("peer-active").addClass("peer-left");
        	$(dataCont).find("#peer-status-cont").text("( Has left )");
            }
        }
        
        function updatePeerStatus(peerId, status){
            var dataCont = document.getElementById(peerId);
            if(dataCont){
        	$(dataCont).find("#peer-status-cont").text(status);
            }
        }
        
        function createPeerCont(peerId){
            var d = document.getElementById('peer-data-temp').cloneNode(true);
            d.id=peerId;
            return d;
        }
        
        function getPeerIdCont(peerId){
            return createDivWithText(peerID);
        }
        
        function createDivWithText(text){
            var d = document.createElement("div");
            $(d).text(d);
            return d;
        }
        
        function clearElement(elem){
            while (elem.firstChild) {
        	elem.removeChild(elem.firstChild);
        	}
        }

        var appState = new WsState("APP_STATE",{
            /* when the server sends us the init data */
            "STATUS-APP:PEER:INIT" : function(ec){
        	
        	var model = ec.event.data.model;
        	setOurId(model.clientId);
        	setOurStatus(model.status);
        	setPeerData(model.peersData);
            },
            
            "PEER:STATUS:UPDATED" : function(ec){
        	updatePeerStatus(ec.event.header.from, ec.event.params.status);
            },
            
            "STATUS-APP:PEERS:REFRESH" : function(ec){
        	setPeerData(ec.event.data.peersData);
            },
            
            "EBUS:PEER:REMOVED" : function(ec){
        	setPeerLeft(ec.event.params.peerId);
            },
            
            "STATUS-APP:PEER-REPLACE:DENIED" : function(ec){
        	var d = ec.event.data;
        	rollbackPeerReplace(d.oldPeerId);
        	alert("Can't replace peer '"+d.oldPeerId+"' with '"+d.newPeerId+"' :\n"+d.reason);
            },
            "STATUS-APP:PEER-REPLACE:ACCEPTED" : function(ec){
        	var d = ec.event.data;
        	replacePeer(d.oldPeerId,d.newPeerId);
            },
            
            "STATUS-APP:STATUS:ERROR" : function(ec){
        	setOurStatus(ec.event.data.currentStatus);
        	alert(ec.event.data.reason);
            }
        });

</script>
</head>
<body>
	<div class="noscript">
		<h2 style="color: #ff0000">Seems your browser doesn't support
			Javascript! Websockets rely on Javascript being enabled. Please
			enable Javascript and reload this page!</h2>
	</div>
	<div id="main-container">
		<div id="connect-container">
			<div>
				<span>Connect to service implemented using:</span> <br />
				<!--             echo example using new programmatic API on the server side -->
				<!--             <input id="radio1" type="radio" name="group1" value="/examples/websocket/echoProgrammatic" -->
				<!--                    onclick="updateTarget(this.value);"/> <label for="radio1">programmatic API</label> -->
				<!--             <br/> -->
				<!--             echo example using new annotation API on the server side -->
				<!--             <input id="radio2" type="radio" name="group1" value="/examples/websocket/echoAnnotation" -->
				<!--                    onclick="updateTarget(this.value);"/> <label for="radio2">annotation API (basic)</label> -->
				<!--             <br/> -->
				<!-- echo example using new annotation API on the server side -->
				<input id="radio3" type="radio" name="group1"
					value="/ebus/ws/eventbus" onclick="updateTarget(this.value);" /> <label
					for="radio3">Default</label> <br />
				<!-- echo example using new annotation API on the server side -->
				<!-- Disabled by default -->
				<!--
            <input id="radio4" type="radio" name="group1" value="/examples/websocket/echoAsyncAnnotation"
                   onclick="updateTarget(this.value);"/> <label for="radio4">annotation API (async)</label>
            -->
			</div>
			<div>
				<input id="target" type="text" size="40" style="width: 350px" />
			</div>
			<div>
				<button id="connect" onclick="connect();">Connect</button>
				<button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
				<button id="refresh-peers" disabled="disabled"
					onclick="refreshPeers();">Refresh Peers</button>
			</div>
			<div id="infoCont" style="display: none;"></div>
			<div>
				<textarea id="message" style="width: 350px">Here is a message!</textarea>
			</div>
			<div>
				<button id="echo" onclick="echo();" disabled="disabled">Update
					Status</button>
			</div>
		</div>
		<div id="data-container">
			<div>
				<label for="our-data">My data: </label>
				<div id="our-data">

					<div>
						<label for="our-id">Id: </label>
						<div id="our-id" class="data-div"></div>
					</div>
					<div>
						<label for="our-status">Status: </label>
						<div id="our-status" class="data-div"></div>
					</div>
				</div>
			</div>
			<div>
				<label for="peers-data">Peers data:</label>
				<div id="peers-data"></div>
			</div>
			<div id="templates" hidden="true">
				<div id="peer-data-temp" class="peer-data">
					<div id="peer-id-cont">peer id</div>
					:
					<div id="peer-actions-cont">
						<button id="replace-button">Replace</button>
						<button id="update-button" style="display: none;">Update</button>
					</div>
					<div id="peer-status-cont">peer status</div>
				</div>

			</div>
		</div>
	</div>
</body>
</html>